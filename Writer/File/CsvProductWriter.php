<?phpnamespace DnD\Bundle\MagentoConnectorBundle\Writer\File;use Pim\Bundle\CatalogBundle\Manager\MediaManager;use Pim\Bundle\CatalogBundle\Model\AbstractProductMedia;use DnD\Bundle\MagentoConnectorBundle\Helper\SFTPConnection;/** * * @author    Mimosa <mimosa@dnd.fr> * @copyright 2014 Agence Dn'D (http://www.dnd.fr) * @license   http://www.dnd.fr */ class CsvProductWriter extends CsvWriter{    /**     * @param MediaManager $mediaManager     */    protected $mediaManager;         /**     * @var string     */    protected $imageFolderPath;    /**     * @var boolean     */    protected $exportImages;    /**     * @param MediaManager $mediaManager     */    public function __construct(MediaManager $mediaManager)    {        $this->mediaManager = $mediaManager;    }    /**     * Set exportImages     *     * @param string $imageFolderPath imageFolderPath     *     * @return string     */    public function setImageFolderPath($imageFolderPath)    {	    $this->imageFolderPath = $imageFolderPath;    }    /**     * get image Folder Path     *     * @return string imageFolderPath     */    public function getImageFolderPath()    {	    return $this->imageFolderPath;    }    /**     * get exportImages     *     * @return string exportImages     */    public function getExportImages()    {        return $this->exportImages;    }    /**     * Set exportImages     *     * @param string $exportImages exportImages     *     * @return AbstractProcessor     */    public function setExportImages($exportImages)    {        $this->exportImages = $exportImages;        return $this;    }    /**     * {@inheritdoc}     */    public function write(array $items)    {        $products = [];        if (!is_dir(dirname($this->getPath()))) {            mkdir(dirname($this->getPath()), 0777, true);        }        foreach ($items as $item) {            $products[] = ($this->getExportImages()) ? $item['product'] : $this->removeMediaColumns($item['product']);            if($this->getExportImages()){                foreach ($item['media'] as $media) {                    if ($media) {                        $this->sendMedia($media);                    }                }            }        }        $this->items = array_merge($this->items, $products);        $sftpConnection = new SFTPConnection($this->getHost(), $this->getPort());        $sftpConnection->login($this->getUsername(), $this->getPassword());        if(file_exists($this->getFilePath())){	        $sftpConnection->uploadFile($this->getFilePath(), $this->getRemoteFilePath());        }    }        /**     * @param AbstractProductMedia $media     *     * @return void     */    public function sendMedia(AbstractProductMedia $media)    {	    if (null === $media->getFilePath() || '' === $media->getFileName()) {            return;        }                $exportPath = $this->mediaManager->getExportPath($media);        $dirname = dirname($exportPath);        $sftpConnection = new SFTPConnection($this->getHost(), $this->getPort());		$sftpConnection->login($this->getUsername(), $this->getPassword());		$sftpConnection->createDirectory($this->getImageFolderPath() . $dirname);		$sftpConnection->uploadFile($media->getFilePath(), $this->getImageFolderPath().$exportPath);    }    /**     * @param array $item     * Remove all column of attributes with type media     * @return array     */    protected function removeMediaColumns($item)    {        $mediaColumns         = array();        $attributeEntity      = $this->entityManager->getRepository('Pim\Bundle\CatalogBundle\Entity\Attribute');        $mediaAttributesCodes = $attributeEntity->findMediaAttributeCodes();        foreach($mediaAttributesCodes as $mediaAttributesCode){            unset($item[$mediaAttributesCode]);        }        return $item;    }        /**     * {@inheritdoc}     */    public function getConfigurationFields()    {        return            array_merge(                parent::getConfigurationFields(),                array(                    'imageFolderPath' => array(                        'options' => array(                            'label'    => 'dnd_magento_connector.export.imageFolderPath.label',                            'help'     => 'dnd_magento_connector.export.imageFolderPath.help',                            'required' => true                        )                    ),                    'exportImages' => array(                        'type'    => 'switch',                        'options' => array(                            'help'    => 'dnd_magento_connector.export.exportImages.help',                            'label'   => 'dnd_magento_connector.export.exportImages.label',                        )                    )                )            );    }}