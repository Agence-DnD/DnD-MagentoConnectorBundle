<?phpnamespace DnD\Bundle\MagentoConnectorBundle\Writer\File;use Pim\Bundle\CatalogBundle\Manager\MediaManager;use Pim\Bundle\CatalogBundle\Model\AbstractProductMedia;use DnD\Bundle\MagentoConnectorBundle\Helper\SFTPConnection;/** * * @author    Mimosa <mimosa@dnd.fr> * @copyright 2014 Agence Dn'D (http://www.dnd.fr) * @license   http://www.dnd.fr */ class CsvProductWriter extends CsvWriter{    /**     * @param MediaManager $mediaManager     */    protected $mediaManager;         /**     * @var string     */    protected $imageFolderPath;        /**     * @param MediaManager $mediaManager     */    public function __construct(MediaManager $mediaManager)    {        $this->mediaManager = $mediaManager;    }        public function setImageFolderPath($imageFolderPath)    {	    $this->imageFolderPath = $imageFolderPath;    }        public function getImageFolderPath()    {	    return $this->imageFolderPath;    }    /**     * {@inheritdoc}     */    public function write(array $items)    {        $products = [];        if (!is_dir(dirname($this->getPath()))) {            mkdir(dirname($this->getPath()), 0777, true);        }        foreach ($items as $item) {            $products[] = $item['product'];            foreach ($item['media'] as $media) {                if ($media) {                    $this->sendMedia($media);                }            }        }        $this->items = array_merge($this->items, $products);        $sftpConnection = new SFTPConnection($this->getHost(), $this->getPort());        $sftpConnection->login($this->getUsername(), $this->getPassword());        if(file_exists($this->getFilePath())){	        $sftpConnection->uploadFile($this->getFilePath(), $this->getRemoteFilePath());        }    }        /**     * @param AbstractProductMedia $media     *     * @return void     */    public function sendMedia(AbstractProductMedia $media)    {	    if (null === $media->getFilePath() || '' === $media->getFileName()) {            return;        }                $exportPath = $this->mediaManager->getExportPath($media);        $dirname = dirname($exportPath);        $sftpConnection = new SFTPConnection($this->getHost(), $this->getPort());		$sftpConnection->login($this->getUsername(), $this->getPassword());		$sftpConnection->createDirectory($this->getImageFolderPath() . $dirname);		$sftpConnection->uploadFile($media->getFilePath(), $this->getImageFolderPath().$exportPath);    }    /**     * @param AbstractProductMedia $media     *     * @return void     */    protected function copyMedia(AbstractProductMedia $media)    {        if (null === $media->getFilePath() || '' === $media->getFileName()) {            return;        }        $result = $this->mediaManager->copy($media, dirname($this->getPath()));        $exportPath = $this->mediaManager->getExportPath($media);        if (true === $result) {            $this->writtenFiles[sprintf('%s/%s', dirname($this->getPath()), $exportPath)] = $exportPath;        } else {            $this->stepExecution->addWarning(                $this->getName(),                sprintf('Copy of "%s" failed.', $media->getFilename()),                [],                $media            );        }    }        /**     * {@inheritdoc}     */    public function getConfigurationFields()    {        return            array_merge(                parent::getConfigurationFields(),                array(                    'imageFolderPath' => array(                        'options' => array(                            'label'    => 'dnd_magento_connector.export.imageFolderPath.label',                            'help'     => 'dnd_magento_connector.export.imageFolderPath.help',                            'required' => true                        )                    ),                )            );    }}